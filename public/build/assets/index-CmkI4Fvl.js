import{r as i,W as ze,b as k,j as e}from"./app-BOMB9RPx.js";import{h,C as Ue}from"./index-Dofjl7YQ.js";import{H as Ge,N as Le,B as Xe}from"./Nav-B4LcHgH8.js";import{a as qe,F as J,d as Je}from"./index-rLyOIo_R.js";import{N as Ke}from"./notyf.min-DLu_xjpT.js";import{G as Qe}from"./iconBase-CO2Y0hZ5.js";import"./index-DFW5HbVH.js";function Ze(x){return Qe({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"},child:[]}]})(x)}const Y=new Ke,ft=({leave:x,user:K,user_type:et,permissions:Q,notif:Z,userid:ee})=>{const[te,A]=i.useState(!1),[w,se]=i.useState({index:null,date:null}),[ae,re]=i.useState(!0),H={id:ee};i.useEffect(()=>{setTimeout(()=>{re(!1)},10)},[]);const oe=(s,t)=>{A(!0),se({index:s,date:t})},ne=(s,t,a)=>{const r=[...m];r[s][`description_${t}`]=a,b(r);const o={...r[s],date:t,description:a};k.post("timesheets-store",{timesheets:[o]}).then(n=>{console.log("Description updated successfully",n.data)}).catch(n=>{console.error("Error updating the description:",n),n.response&&n.response.data.errors&&Object.values(n.response.data.errors).forEach(c=>Y.error(c))})};i.useState(new Date);const[ie,T]=i.useState(!1),[m,b]=i.useState([]),[M,ce]=i.useState(null),[le,de]=i.useState([]),[S,me]=i.useState({total:{},overtime:{}}),[ue,he]=i.useState({}),{data:pe,setData:v,post:fe,errors:tt}=ze({timesheets:[]}),[j,$]=i.useState(h().startOf("isoWeek").format("YYYY-MM-DD")),[F,xe]=i.useState([]);i.useEffect(()=>{k.get("/getProjectTasks").then(s=>{const t=s.data||{};he(t),de(Object.keys(t).map(a=>({id:a,project_name:t[a].project_name})))}).catch(s=>console.error("Error fetching project tasks:",s)),k.get("/holidays-fetch").then(s=>{console.log(s),xe(s.data)}).catch(s=>console.error("Error fetching holidays:",s))},[]);const[g,be]=i.useState(null);i.useEffect(()=>{je(j)},[j]),i.useEffect(()=>{console.log("Updated Week Data:",m)},[m]);const je=s=>{k.get(`/timesheets/${s}`).then(t=>{const a=t.data.map(r=>{const o=r.entries||{},n={project_id:r.project_id,task_id:r.task_id,status:r.status,is_approved:r.is_approved,id:r.timesheet_ids,...o};return console.log("format",n),n});a.length===0?T(!0):(T(!1),b(a),v("timesheets",a),a[0]&&a[0].status!==void 0&&be(a[0].status),a[0]&&a[0].is_approved!==void 0&&ce(a[0].is_approved)),U(a)}).catch(t=>console.error("Error fetching the timesheet data!",t))},u=s=>h(j).startOf("isoWeek").add(s,"days").format("YYYY-MM-DD"),ge=s=>{const t=h(j).startOf("isoWeek").add(s,"days"),a=t.format("ddd"),r=t.format("MMM D");return{dayName:a,dayDate:r}},ke=()=>{$(h(j).subtract(1,"weeks").format("YYYY-MM-DD"))},Ne=()=>{$(h(j).add(1,"weeks").format("YYYY-MM-DD"))},we=new Date(x==null?void 0:x.sdate),ve=new Date(x==null?void 0:x.edate),P=s=>{const t=new Date(s);return t>=we&&t<=ve},B=s=>F.some(t=>{const a=h(t.start_date,"YYYY-MM-DD"),r=h(t.end_date,"YYYY-MM-DD");return h(s,"YYYY-MM-DD").isBetween(a,r,"day","[]")}),R=(s,t)=>F.some(a=>{const r=h(a.start_date,"YYYY-MM-DD"),o=h(a.end_date,"YYYY-MM-DD");return h(s,"YYYY-MM-DD").isBetween(r,o,"day","[]")&&a.assigned_employees.some(l=>l.id===t)}),ye=(s,t)=>{const a=[...m];a[s]={...a[s],project_id:t,task_id:""},b(a),v("timesheets",a)},_e=(s,t)=>{const a=[...m];a[s]={...a[s],task_id:t},b(a),v("timesheets",a)},[E,W]=i.useState(""),[st,De]=i.useState(!1),[_,I]=i.useState([]),[at,V]=i.useState(""),Te=async(s,t,a)=>{const r=Number(a);if(isNaN(r)||r<0||r>100)return;const o=[...m];o[s]={...o[s],[t]:r},b(o);const n=Object.values(o[s]).filter(d=>!isNaN(d)&&d!=="").reduce((d,N)=>d+Number(N),0),c=o[s].estimateHours||5,l=n>=c;o[s].disabled=l||g===1||P(t)||B(t)&&!R(t,H.id)||L(t),b(o);const p=o.map((d,N)=>({...d,date:u(N%7)})),D=_.map(d=>{const y=p.filter(f=>f.task_id===d.task_id).reduce((f,O)=>f+(Number(O.time_number)||0),0);return{...d,total_time_worked:y}});I(D);let X=!1;const q=[],Ve=p.map((d,N)=>{const y=D.find(f=>f.task_id===d.task_id);if(y){const f=Number(y.estimate_hours),O=Number(d.time_number||0);if(Number(y.total_time_worked||0)+O>f)return q.push(`Task ${y.task_name} has exceeded its estimated hours of ${f}. Please submit your extra task hour in NON-Billable.`),X=!0,{...d,date:u(N%7),time_number:f.toString()}}return{...d,date:u(N%7)}});W(q.join(`
`)),De(X);try{await k.post("/timesheets-store",{timesheets:Ve}),V("Timesheets updated successfully."),W("")}catch(d){console.error("Error submitting timesheets:",d),W("There was an error saving the timesheets. Please try again."),V("")}U(o)};i.useEffect(()=>{E&&console.log("Error:",E)},[E]),i.useEffect(()=>{(async()=>{try{const t=await k.get("/timesheets-time");I(t.data)}catch(t){console.error("Error fetching data:",t)}})()},[m,_]);const Se=async s=>{s.nativeEvent.preventDefault();let t=!1;const a={},r=pe.timesheets.map((o,n)=>{const c=_.find(l=>l.task_id===o.task_id);if(c){const l=Number(c.estimate_hours),p=Number(o.time_number||0);if(Number(c.total_time_worked)+p>l)return a[o.task_id]=`Input time for task "${c.task_name}" exceeds the estimated hours of ${l}.`,t=!0,{...o,date:u(n%7)}}return window.location.reload(),{...o,date:u(n%7)}});v("timesheets",r),t?Object.values(a).forEach(o=>alert(o)):Y.success("Timesheet updated successfully")},[C,Ye]=i.useState([]);i.useEffect(()=>{const s=_.filter(t=>{const a=Number(t.total_time_worked),r=Number(t.estimate_hours);return a>r});Ye(s)},[_]);const z=C.length>0,Me=s=>{s.preventDefault();const t=m.map((a,r)=>({...a,date:u(r%7)}));v("timesheets",t),fe("timesheets-status",{preserveScroll:!0,onSuccess:()=>{Y.success("Timesheets status updated successfully please contact admin "),window.location.reload()},onError:()=>{console.error("Error updating the timesheets status"),Y.error("An error occurred while updating the timesheets status.")}})},Ee=()=>{b([...m,{project_id:"",task_id:"",time_number:""}]),T(!1)},U=s=>{const t={total:{},overtime:{}};for(let a=0;a<7;a++){const r=u(a);let o=0;s.forEach(n=>{const c=n[r]?parseFloat(n[r]):0;o+=c}),t.total[r]=o,o===0?t.overtime[r]=0:(o>8,t.overtime[r]=o-8)}me(t)},We=s=>{const t=h(s).startOf("isoWeek"),a=h(s).endOf("isoWeek");return{start:t,end:a}},Ce=(s,t)=>{const a=s.format("dddd, MMMM DD, YYYY"),r=t.format("dddd, MMMM DD, YYYY");return`${a} - ${r}`},G=We(j),Oe=Ce(G.start,G.end),L=s=>{const t=h(j).startOf("isoWeek").add(s,"days").day();return t===6||t===0},Ae=()=>{let s=0,t=0;return m.forEach(a=>{Array.from({length:7}).forEach((r,o)=>{const n=u(o),c=parseFloat(a[n]||0);s+=c,c>8?t+=1:c<8&&(t+=8-c)})}),{weeklyTotala:s,weeklyOverUnderTimeCount:t}},{weeklyTotala:He,weeklyOverUnderTimeCount:rt}=Ae(),$e=Array.from({length:7}).reduce((s,t,a)=>{const r=u(a),o=S.overtime[r]||0;return o<0&&(s+=Math.abs(o)),s},0),Fe=Array.from({length:7}).reduce((s,t,a)=>{const r=u(a),o=S.overtime[r]||0;return o>0&&(s+=o),s},0);i.useState();const Pe=Fe+$e,Be=async s=>{const t=m[s].id[0];if(console.log("Deleting timesheet ID:",t),!t){console.error("No timesheet ID found");return}try{await k.get(`/timesheets-delete/${t}`),window.location.reload();const a=[...m];a.splice(s,1),b(a),T(a.length===0),v("timesheets",a)}catch(a){console.error("Error deleting timesheet entry:",a)}},[ot,Re]=i.useState([]);i.useState(Array(7).fill({title:"",time:""}));const Ie=async()=>{try{const s=await k.get("/api/non-billable-tasks");Re(s.data.map(t=>t.name))}catch(s){console.error("Error fetching non-billable tasks:",s)}};return i.useEffect(()=>{Ie()},[]),e.jsxs("div",{className:"w-[83%]  absolute right-0 overflow-hidden",children:[e.jsx(Ge,{user:K,notif:Z}),e.jsx(Le,{user_type:Q}),e.jsxs("div",{children:[" ",ae?e.jsx("span",{className:"grid place-items-center h-[20rem]",children:e.jsx("l-waveform",{size:"35",stroke:"3.5",speed:"1",color:"black"})}):e.jsxs(e.Fragment,{children:["  ",e.jsx("div",{className:`modal absolute top-0 left-0 w-full h-full transition-all duration-500 bg-black/50 flex justify-center items-center ${te?"opacity-100 visible pointer-events-auto":"opacity-0 invisible pointer-events-none"}`,children:e.jsxs("div",{className:"w-2/5 p-4 px-6 bg-white rounded-md",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Add Description"}),e.jsx("button",{onClick:()=>A(!1),children:e.jsx(qe,{})})]}),e.jsx("hr",{className:"my-2"}),e.jsxs("form",{className:"py-3 space-y-5",children:[e.jsx("textarea",{type:"text",className:"w-full p-2 border rounded-md",placeholder:"Description",value:w.index!==null&&w.date!==null&&m[w.index][`description_${w.date}`]||"",onChange:s=>ne(w.index,w.date,s.target.value)}),e.jsx("div",{})]})]})}),e.jsxs("div",{className:"space-x-2",style:{display:"flex",justifyContent:"space-between",margin:"1rem"},children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-bold ",children:"Week"}),": ",e.jsxs("span",{className:"text-red-500 underline",children:[" ",Oe]})]}),e.jsxs("div",{children:[e.jsx("button",{onClick:ke,className:"underline",children:e.jsx(Xe,{className:"text-[2rem] text-blue-500"})}),e.jsx("button",{onClick:Ne,className:"underline",children:e.jsx(Ue,{className:"text-[2rem] text-blue-500"})})]})]}),e.jsxs("div",{className:"px-4",children:[e.jsx("div",{className:"flex justify-end border  bg-[#356A6A] rounded-t-md p-3",children:z?e.jsx("button",{className:"p-2 text-white bg-blue-800 rounded-md",children:e.jsx(J,{})}):e.jsx("button",{onClick:Ee,className:"p-2 text-white bg-blue-800 rounded-md",children:e.jsx(J,{})})}),C.length>0&&e.jsx("div",{className:"text-red-500",children:C.map((s,t)=>e.jsxs("p",{children:["Task ",s.task_name," has exceeded its estimated hours of ",s.estimate_hours,".please Submit your extra task hour in NON-Billable"]},t))}),e.jsxs("form",{onSubmit:s=>s.preventDefault(),children:[e.jsxs("table",{className:"w-full  border-[3px]",children:[e.jsx("thead",{className:"bg-[#465584] text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-1 border",children:"Project"}),e.jsx("th",{className:"p-1 border",children:"Task"}),Array.from({length:7}).map((s,t)=>{const{dayName:a,dayDate:r}=ge(t);return e.jsxs("th",{className:"p-1 text-center border",children:[e.jsx("div",{children:r}),e.jsx("div",{children:a})]},t)}),e.jsx("td",{className:"w-[88px]",children:"Total Time"})]})}),e.jsx("tbody",{children:ie?e.jsx("tr",{children:e.jsxs("td",{colSpan:"8",children:["   ",e.jsxs("p",{className:"grid place-items-center",children:[" ",e.jsx("h1",{className:"font-bold text-[1.5rem]",children:"We couldn't find any data"}),"Sorry we can't find any timesheet records on this week. Please add timesheet record ."]})]})}):e.jsxs(e.Fragment,{children:[m.map((s,t)=>{var o;const a=s.id;console.log(a),m.forEach(n=>{});const r=Array.from({length:7}).reduce((n,c,l)=>{const p=u(l);return n+parseFloat(s[p]||0)},0);return e.jsxs("tr",{children:[e.jsx("td",{className:"bg-white w-[]",children:e.jsxs("select",{className:"bg-[#6699CC] text-white w-[147px] text-[1rem]",name:`timesheets[${t}].project_id`,value:s.project_id,onChange:n=>ye(t,n.target.value),children:[e.jsx("option",{value:"",children:"Select Project"}),le.map(n=>e.jsx("option",{value:n.id,className:"",children:n.project_name},n.id))]})}),e.jsx("td",{className:"bg-white w-[]",children:e.jsxs("select",{className:"bg-[#6699CC] text-white border-white border text-[1rem] w-[147px]",name:`timesheets[${t}].task_id`,value:s.task_id,onChange:n=>_e(t,n.target.value),children:[e.jsx("option",{value:"",children:"Select Task"}),(((o=ue[s.project_id])==null?void 0:o.tasks)||[]).map(n=>e.jsx("option",{value:n.task_id,children:n.task_name},n.task_id))]})}),Array.from({length:7}).map((n,c)=>{const l=u(c),p=g===1||P(l)||B(l)&&!R(l,H.id)||L(l);return e.jsx("td",{className:"w-[] bg-white border-2 ",children:e.jsxs("div",{className:"flex",children:[e.jsx("input",{className:`form-control ${p?"bg-[#f7e0e0] text-white w-[60px] border-[#594684]":"w-[60px] border-[#465584]"}`,type:"number",name:`timesheets[${t}][${l}]`,value:s[l]!==void 0?s[l]:"",onChange:D=>Te(t,l,D.target.value),disabled:p,min:0,max:100}),e.jsx("button",{onClick:()=>oe(t,l),className:"text-[#F6A12E] px-2 py-2 text-sm rounded-md font-medium ",children:e.jsx(Je,{})})]})},c)}),e.jsx("td",{className:"bg-white",children:e.jsx("input",{className:" text-center form-control w-[88px] bg-[#d3e0ea] text-black",type:"number",value:r,disabled:!0})}),e.jsx("td",{children:g===1?"":e.jsx("button",{onClick:()=>Be(t),children:e.jsx(Ze,{className:"text-red-500"})})})]},t)}),e.jsxs("tr",{className:"bg-[#e0f7e0] ",children:[e.jsx("td",{className:"border "}),e.jsx("td",{className:"border ",children:"Total"}),Array.from({length:7}).map((s,t)=>{const a=u(t);return e.jsx("td",{className:"p-2 border",children:S.total[a]||0},t)}),e.jsx("td",{className:"text-center",children:He})]}),e.jsxs("tr",{className:"bg-[#fff] ",children:[e.jsx("td",{className:"border "}),e.jsx("td",{className:"border ",children:" Extra Work hours "}),Array.from({length:7}).map((s,t)=>{const a=u(t),r=S.overtime[a]||0,o=r>0?`+${r}`:r;return e.jsx("td",{style:{color:o>0?"green":"red"},className:"p-2 text-center border",children:r===0?0:o},t)}),e.jsxs("td",{className:"text-center",children:["-",Pe]})]})]})})]}),e.jsxs("div",{className:"flex justify-between   bg-[#356A6A]",children:[e.jsxs("div",{className:"w-[50%] grid place-items-center border-2 p-3",children:[e.jsx("button",{onClick:Se,className:"border-2 p-2 bg-[#465584] text-white rounded-md",disabled:g===1,children:"Save time Status"}),g===1?e.jsxs(e.Fragment,{children:["  ",e.jsx("p",{className:"mt-3 text-white",children:"Already submitted timesheet status as approved"})]}):e.jsx("p",{className:"mt-3 text-white",children:"Submit your timesheet status as approved"})]}),e.jsxs("div",{className:"w-[50%] grid place-items-center border-2 p-3",children:[z?e.jsx("button",{className:" p-2 bg-[#777475] text-white rounded-md",disabled:g===1,children:"Submit time Status"}):e.jsx("button",{onClick:Me,className:"border-2 p-2 bg-[#F06495] text-white rounded-md",disabled:g===1,children:"Submit time Status"}),e.jsx("div",{className:"mt-3",children:M===3?"":M===1?e.jsx("span",{className:"font-bold text-green-600",children:"Timesheet Approved"}):M===0?e.jsx("span",{className:"font-bold text-red-600",children:"Timesheet Rejected"}):""}),g===1?e.jsxs(e.Fragment,{children:["    ",e.jsx("p",{className:"mt-3 text-white",children:"contact admin to edit timesheet"})]}):e.jsx("p",{className:"mt-3 text-white",children:"Save to update the pending timesheet"})]})]})]})]})]})]})]})};export{ft as default};
